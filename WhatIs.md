# Message Queue

# 什么是消息队列?

消息队列是一种能实现生产者到消费者单向通信的通信模型，  
而一般大家说MQ是指实现了这个模型的中间件，比如RabbitMQ、RocketMQ、Kafka等。

消息队列中间件是指利用高效可靠的消息传递机制进行与平台无关的数据交流，并基于数据通信来进行分布式系统的集成。
通过提供消息传递和消息排队模型，它可以在分布式环境下提供应用解耦、弹性伸缩、冗余存储、流量削峰、异步通信、数据同步等等功能。
是分布式系统架构中的一个重要组件。

# 特点
Message Queue把请求的压力保存一下，逐渐释放出来，让处理者按照自己的节奏来处理。
Message Queue引入一下新的结点，让系统的可靠性会受Message Queue结点的影响。
Message Queue是异步单向的消息。发送消息设计成是不需要等待消息处理的完成。

# 为什么使用消息队列？

主要解决应用耦合，异步消息，流量削峰等问题。
实现高性能，高可用，可伸缩和最终一致性架构。
```text
解耦
异步通信
消峰

冗余
扩展性 
灵活性 & 峰值处理能力
可恢复性 - 系统的一部分组件失效时，不会影响到整个系统 
缓冲
```
```text
消息队列中间件是分布式系统中重要的组件
	主要解决应用耦合，异步消息，流量削锋等问题
	实现高性能，高可用，可伸缩和最终一致性架构
解耦 
	在项目启动之初来预测将来项目会碰到什么需求，是极其困难的。
		消息系统在处理过程中间插入了一个隐含的、基于数据的接口层，两边的处理过程都要实现这一接口。
		这允许你独立的扩展或修改两边的处理过程，只要确保它们遵守同样的接口约束。 
冗余 
	有些情况下，处理数据的过程会失败
		除非数据被持久化，否则将造成丢失。
	消息队列把数据进行持久化直到它们已经被完全处理，通过这一方式规避了数据丢失风险。
	许多消息队列所采用的”插入-获取-删除”范式中
		在把一个消息从队列中删除之前，需要你的处理系统明确的指出该消息已经被处理完毕
		从而确保你的数据被安全的保存直到你使用完毕。 
扩展性 
	因为消息队列解耦了你的处理过程
		所以增大消息入队和处理的频率是很容易的，只要另外增加处理过程即可
		不需要改变代码、不需要调节参数。扩展就像调大电力按钮一样简单。 
灵活性 & 峰值处理能力 
	在访问量剧增的情况下，应用仍然需要继续发挥作用，但是这样的突发流量并不常见
		如果为以能处理这类峰值访问为标准来投入资源随时待命无疑是巨大的浪费
	使用消息队列能够使关键组件顶住突发的访问压力，而不会因为突发的超负荷的请求而完全崩溃。 
可恢复性 
	系统的一部分组件失效时，不会影响到整个系统。
		消息队列降低了进程间的耦合度，所以即使一个处理消息的进程挂掉，加入队列中的消息仍然可以在系统恢复后被处理。 
顺序保证 
	在大多使用场景下，数据处理的顺序都很重要
		大部分消息队列本来就是排序的，并且能保证数据会按照特定的顺序来处理。
		Kafka保证一个Partition内的消息的有序性。 
缓冲 
	在任何重要的系统中，都会有需要不同的处理时间的元素。
		例如，加载一张图片比应用过滤器花费更少的时间。
	消息队列通过一个缓冲层来帮助任务最高效率的执行———写入队列的处理会尽可能的快速。
		该缓冲有助于控制和优化数据流经过系统的速度。 
异步通信 
	很多时候，用户不想也不需要立即处理消息。
		消息队列提供了异步处理机制，允许用户把一个消息放入队列，但并不立即处理它。
		想向队列中放入多少消息就放多少，然后在需要的时候再去处理它们。
```

# 场景
异步处理
应用解耦
流量削锋
消息通讯
	进程间通讯和系统间的消息通知，比如在分布式系统中。 

# vs RPC
在架构上，RPC和Message Queue的差异点是，Message Queue有一个中间结点Message Queue(broker)，可以把消息存储。

RPC的特点
	同步调用，对于要等待返回结果/处理结果的场景，RPC是可以非常自然直觉的使用方式。RPC也可以是异步调用。
	由于等待结果，Consumer（Client）会有线程消耗。
		如果以异步RPC的方式使用，Consumer（Client）线程消耗可以去掉。
		但不能做到像消息一样暂存消息/请求，压力会直接传导到服务Provider。
场景
	希望同步得到结果的场合，RPC合适。
	希望使用简单，则RPC；RPC操作基于接口，使用简单，使用方式模拟本地调用。异步的方式编程比较复杂。
	不希望发送端（RPC Consumer、Message Sender）受限于处理端（RPC Provider、Message Receiver）的速度时，使用Message Queue。

## 案例
###  在淘宝下了一笔订单后
```text
1. 消息通知系统
  通知商家，你有一笔新的订单，请及时发货
2. 推荐系统
  更新用户画像，重新给用户推荐他可能感兴趣的商品
3. 会员系统
  更新用户的积分和等级信息
... ...
```
